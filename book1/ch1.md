汇编基础

1.1 x86通用寄存器

1.1.1 32位架构

8个通用寄存器

EAX：累加器寄存器，用于存放函数返回值

ECX: 计数寄存器，用于循环计数，但是上层语言不会使用LOOP，一般通过条件跳转实现循环

ESP：栈指针寄存器，用于指向栈顶

ESI：源变址寄存器，用于存放源数据地址

EDI：目的变址寄存器，用于存放目的数据地址

EBP：在高级语言中来引用栈上的局部变量和函数参数，一般不用于寄存器间的数据传递。被称为基址指针寄存器或帧指针寄存器

EFLAGS：标志寄存器，用于存放一些标志位，比如进位标志、零标志、符号标志等

EIP：指令指针寄存器，用于存放下一条要执行的指令地址

1.1.2 64位架构

EAX - RAX
ECX - RCX
EDX - RDX
EBX - RBX
ESP - RSP
EBP - RBP
ESI - RSI
EDI - RDI
向前兼容

1.2 常用汇编指令

1个opcode和0个或多个operand组成，大多数指令包含两个operand，一个是目的操作数，一个是源操作数

1.2.1 整数加减指令

ADD，例如
```asm
ADD EAX,16
```
表示将EAX寄存器的值加上16,结果存放在EAX寄存器中

SUB，例如
```asm
SUB EAX,16
```

ADD，例如
```asm
ADD AL,CL
```
表示将AL寄存器的值加上CL寄存器的值，结果存放在AL寄存器中。int8类型的数据相加，结果存放在int8类型的寄存器中

1.2.2 数据传输指令

MOV，例如
```asm
MOV EAX,16

MOV EAX,EBX
```
表示将16传送到EAX寄存器中；将EBX寄存器的值传送到EAX寄存器中。

内存寻址：

Displacement：立即数，表示偏移量，例如
```asm
MOV EAX,[0x12345678]
```
表示将0x12345678地址中的数据传送到EAX寄存器中

Base：基址寄存器，一般用于运行时动态分配的变量和数据结构，例如

```asm
MOV EAX,[EBX]
```
表示将EBX寄存器中的地址中的数据传送到EAX寄存器中

Index：变址寄存器，一般用于数组和结构体的访问。不可以作为索引寄存器使用，例如
```asm
MOV EAX,[EBX+ECX*4]
```
表示将EBX寄存器中的地址加上ECX寄存器的值乘以4后的地址中的数据传送到EAX寄存器中

Scale：倍数，表示Index寄存器的倍数，可以是1，2，4，8，例如
```asm
MOV EAX,[EBX+ECX*4]
```
表示将EBX寄存器中的地址加上ECX寄存器的值乘以4后的地址中的数据传送到EAX寄存器中

1.2.3 入栈和出栈指令

x86一些指令虽然不直接以ESP为操作数，但是会影响ESP的值，比如CALL，RET，PUSH，POP等指令

PUSH，例如
```asm
PUSH EAX
```
表示将EAX寄存器中的值压入栈中，等价于
```asm
SUB ESP,4
MOV [ESP],EAX
```
即将ESP寄存器的值减去4，然后将EAX寄存器的值传送到ESP寄存器指向的地址中。
为什么等价呢，因为栈是向下生长的，所以ESP寄存器的值减去4，表示栈顶指针向下移动4个字节，
然后将EAX寄存器的值传送到ESP寄存器指向的地址中。至于什么是向下生长，可以理解为栈是从高地址向低地址生长的，所以ESP寄存器的值减去4，表示栈顶指针向下移动4个字节。

POP，例如
```asm
POP EAX
```
表示将栈顶的值弹出到EAX寄存器中，等价于
```asm
MOV EAX,[ESP]
ADD ESP,4
```
即将ESP寄存器指向的地址中的值传送到EAX寄存器中，然后ESP寄存器的值加上4，表示栈顶指针向上移动4个字节

1.2.4 分支跳转指令

JMP，例如
```asm
JMP 0x12345678
```
表示跳转到0x12345678地址处执行

JMP，例如
```asm
JMP EAX
```
表示跳转到EAX寄存器中的地址处执行

JMP，例如
```asm
JMP [EAX]
```
和JMP EAX的区别是，JMP EAX是直接跳转到EAX寄存器中的地址处执行，
而JMP [EAX]是跳转到EAX寄存器中的地址处的地址处执行。

1.2.5 过程调用指令

函数在汇编语言中称为过程，过程调用指令有CALL和RET。CALL比JVP多了一个功能，就是将下一条指令的地址压入栈中，以便RET指令返回时使用。
CALL指令先将下一条指令的地址压入栈中，然后跳转到指定的地址处执行。RET指令从栈中弹出地址，然后跳转到该地址处执行。这样当函数执行完毕后，可以通过RET指令返回到调用函数的下一条指令处执行。

CALL，例如
```asm
CALL 0x12345678
```
表示调用0x12345678地址处的函数

CALL，例如
```asm
CALL EAX
```
表示调用EAX寄存器中的地址处的函数，等价于
```asm
PUSH EIP
JMP EAX
```
即将下一条指令的地址压入栈中，然后跳转到EAX寄存器中的地址处执行

RET，例如
```asm
RET 8
```
有立即数参数，表示从栈中弹出地址，然后跳转到该地址处执行，同时ESP寄存器的值加上8，表示栈顶指针向上移动8个字节。
什么叫栈中弹出地址，即将栈顶的值弹出到EIP寄存器中，然后EIP寄存器的值加上8，表示跳转到EIP寄存器的值加上8的地址处执行
等价于
```asm
RET
ADD ESP,8
```
即从栈中弹出地址，然后跳转到该地址处执行，同时ESP寄存器的值加上8，表示栈顶指针向上移动8个字节

1.3 内存分页机制

1.3.1 线性地址

在分页模式下，CPU访问的地址称为线性地址，线性地址是一个32位的地址，分为三部分：页目录表索引、页表索引和页内偏移。
需要由CPU的MMU（Memory Management Unit）将线性地址转换为物理地址，MMU的工作是将线性地址的高10位作为页目录表索引，中间10位作为页表索引，低12位作为页内偏移。

1.3.2 80386两级页表

80386的页表是两级的，页目录表有1024个页目录项，每个页目录项占4个字节，页目录表占4KB，页表有1024个页表项，每个页表项占4个字节，页表占4KB，页大小为4KB，所以一个页表项对应一个页。
地址总线为32位。分页机制将每个物理内存页面的大小定义为4kb

总结一下就是，10位给页目录索引，构成1024个。每一个相当于一个entry，即一个页表，而每个页表有1024个entry，即页表项，每个entry对应一个页，页大小为4KB，所以一个entry对应一个页，即4KB。
在页内，低12位是页内偏移，即一个页内的偏移量，这样就可以定位到一个具体的地址。

1.3.3 PAE三级页表

PAE（Physical Address Extension）是Intel提出的一种扩展物理地址的技术，PAE技术可以扩展物理地址到36位，即支持64GB的物理内存。PAE技术引入了三级页表，页目录表有4个页目录项，每个页目录项占8个字节，页目录表占32字节，页表有512个页表项，每个页表项占8个字节，页表占4KB，页大小为4KB，所以一个页表项对应一个页。

区别就在于，在页目录索引之前，还有一个页目录指针，这个指针指向一个页目录表，这个页目录表有4个entry，每个entry对应一个页目录表，每个页目录表有512个entry，每个entry对应一个页表，每个页表有512个entry，每个entry对应一个页，即4KB。

1.3.4 x64四级页表

x64的页表是四级的，页目录指针表有512个页目录指针项，每个页目录指针项占8个字节，页目录指针表占4KB，页目录表有512个页目录项，每个页目录项占8个字节，页目录表占4KB，页表有512个页表项，每个页表项占8个字节，页表占4KB，页大小为4KB，所以一个页表项对应一个页。

1.3.5 虚拟内存

页目录本身也是一个页。因为系统空间所有进程共享，所以对应的，而大多数进程并不会申请所有的内存，所以页目录表和页表并不会占用所有的内存，只有在需要的时候才会分配。进程是以页面为单位进行内存分配的。操作系统一般只对进程已经申请的区间进行分配，而不会对整个进程的地址空间进行分配。
当内存不够用时，操作系统会将一部分内存写入磁盘，这部分内存称为虚拟内存。虚拟内存是一种内存管理技术，它允许程序使用比实际物理内存更大的内存空间。虚拟内存是一种抽象概念，它将物理内存和磁盘空间组合在一起，形成一个连续的地址空间，程序可以通过虚拟内存访问物理内存和磁盘空间。虚拟内存的大小是由操作系统决定的，程序不能直接访问虚拟内存，只能通过操作系统提供的接口访问虚拟内存。

1.4 汇编代码风格

go汇编风格和汇编语言对比

操作数的宽度，例如
```asm
MOV EAX,16
```
go汇编中的操作数宽度是固定的，例如
```asm
MOVQ $16,AX
```
表示将16传送到AX寄存器中，Q表示quadword，表示64位，即8个字节

操作数的顺序

汇编语言中的操作数在后
```asm
MOV EAX,16
```

go汇编中的操作数顺序是相反的
```asm
MOVQ AX,$16
```
表示将AX寄存器的值传送到16中


地址的表示

汇编语言中的地址是方括号括起来的
```asm
MOV EAX,[0x12345678]
```

go汇编中的地址是方括号括起来的
```asm
MOVQ AX,16(SP)(BX*2)
```
表示将16传送到AX寄存器中，SP表示栈指针，BX表示基址寄存器，2表示倍数,意思是将16传送到AX寄存器中，地址是SP寄存器的值加上BX寄存器的值乘以2后的地址

立即数风格

汇编语言中的立即数是直接写在指令中的
```asm
MOV EAX,16
```

go汇编中的立即数是用$符号表示的
```asm
MOVQ $16,AX
```









